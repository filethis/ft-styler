<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../cbn-copy-clipboard/cbn-copy-clipboard-behavior.html">
<link rel="import" href="../cbn-copy-clipboard/cbn-copy-clipboard.html">
<link rel="import" href="../ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../ft-labeled-icon-button/ft-labeled-icon-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../juicy-ace-editor/juicy-ace-editor.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../polymer/lib/utils/debounce.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="ft-css-declaration-editor.html">


<!--
`<ft-styler>`

aaaaaaaaa

@demo
-->
<dom-module id="ft-styler">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
                min-width:400px;
                @apply --layout-vertical;
            }
        </style>

        <!-- Element heaader -->
        <div
                class="layout horizontal center"
                style="padding-left:12px; padding-right:12px; padding-top:5pt; padding-bottom:5pt; ">

            <!-- Title -->
            <iron-label
                    style="font-family:Arial; font-size:14pt; ">
                <[[selector]]>
            </iron-label>

            <div class="flex"></div>

            <!-- Example button -->
            <ft-labeled-icon-button
                    id="documentationButton"
                    icon="dashboard"
                    label="Sample"
                    on-tap="_onDocumentationButtonClicked">
            </ft-labeled-icon-button>

            <!-- Documentation button -->
            <ft-labeled-icon-button
                    id="documentationButton"
                    icon="info-outline"
                    label="Docs"
                    on-tap="_onDocumentationButtonClicked">
            </ft-labeled-icon-button>

            <!-- Copy button -->
            <ft-labeled-icon-button
                    id="copyCssButton"
                    icon="content-paste"
                    label="Copy"
                    on-tap="_onCopyCssButtonClicked">
            </ft-labeled-icon-button>

            <!-- Apply -->
            <ft-labeled-icon-button
                    id="applyButton"
                    icon="exit-to-app"
                    label="Apply"
                    on-tap="_onApplyButtonClicked">
            </ft-labeled-icon-button>
        </div>

        <!-- Generated CSS -->
        <juicy-ace-editor
                id="css"
                readonly
                style="border:1px solid #DDD; "
                theme="ace/theme/chrome"
                mode="ace/mode/text"
                fontsize="14px"
                softtabs
                tabsize="4"></juicy-ace-editor>

        <!-- Declaration header -->
        <div
                class="layout horizontal center"
                style="padding-left:12px; padding-right:12px; padding-top:5pt; padding-bottom:5pt; ">

            <!-- Title -->
            <iron-label
                    style="font-family:Arial; font-size:12pt; ">
                Declarations
            </iron-label>

            <div class="flex"></div>

            <!-- New button -->
            <ft-labeled-icon-button
                    id="newDeclarationButton"
                    icon="add"
                    label="New"
                    on-tap="_onNewDeclarationButtonClicked">
            </ft-labeled-icon-button>
        </div>

        <!-- Declaration List -->
        <div
                class="scroll"
                style="padding-left:12px; padding-right:12px; padding-bottom:12px; ">

            <template is="dom-repeat" items="{{declarations}}" as="declaration">
                <ft-css-declaration-editor
                        declaration="[[declaration]]">
                </ft-css-declaration-editor>
            </template>
        </div>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

        <!-- Clipboard -->
        <cbn-copy-clipboard
                id="clipboard">
        </cbn-copy-clipboard>

    </template>

    <script>
        Polymer({

            is: 'ft-styler',

            observers: [
                '_onDeclarationsListChanged(declarations.splices)'
            ],

            listeners:
            {
                'delete-button-clicked': '_onDeleteDeclarationButtonClicked',
                'declaration-changed': '_onDeclarationChanged'
            },

            properties: {

                selector: {
                    type: String,
                    notify: true,
                    value: "ft-thing",
                    observer: "_onSettingChangedDebounced"
                },

                declarations: {
                    type: Array,
                    notify: true,
                    value: function () {
                            return [
                                {
                                    name: "color",
                                    value: "red"
                                },
                                {
                                    name: "padding",
                                    value: "12px"
                                },
                                {
                                    name:"--ft-connection-special",
                                    value: "foo"
                                },
                                {
                                    name:"--ft-connection-another",
                                    value: "bar"
                                },
                                {
                                    name:"background-color",
                                    value: "green"
                                },
                                {
                                    name:"font-family",
                                    value: "Ariel"
                                }
                            ]
                        }
                },

                css: {
                    type: String,
                    notify: true
                }
            },

            ready: function()
            {
                // TODO: The "editor" property is undefined when the ready() method is called. That seems wrong. Fix.
                this.async(function()
                {
                    var editor = this.$.css;
                    var editorInternal = editor.editor;
                    var session = editorInternal.getSession();

                    // Disable syntax checking
                    session.setUseWorker(false);

                    editorInternal.setOptions({
                        maxLines:Infinity,
                        minLines:3
                    });
                }.bind(this), 100)
            },

            _onSettingChangedDebounced: function()
            {
                this._settingChangedDebouncer = Polymer.Debouncer.debounce
                (
                    this._settingChangedDebouncer,
                    Polymer.Async.timeOut.after(60),
                    this._onSettingChanged.bind(this)
                );
            },

            _onSettingChanged: function()
            {
                this._generateCss();
            },

            _generateCss: function()
            {
                var css = "--" + this.selector + ": {";
                this.declarations.forEach(function(declaration)
                {
                    css += "\n    " + declaration.name + ": " + declaration.value + ";";
                });
                css += "\n}";

                var editor = this.$.css;
                var editorInternal = editor.editor;
                editor.value = css;
                editorInternal.selection.selectFileStart();
            },

            _onNewDeclarationButtonClicked: function(event)
            {
                var declaration = {
                    name: "foo",
                    value: "bar"
                };

                // Add the declaration
                var index = this.declarations.indexOf(declaration);
                this.push('declarations', declaration);
            },

            _onDeleteDeclarationButtonClicked: function(event)
            {
                var declaration = event.detail;

                // Remove the given declaration
                var index = this.declarations.indexOf(declaration);
                this.splice('declarations', index, 1);
            },

            _onApplyButtonClicked: function(event, detail)
            {
                var invalidStylables = this._collectInvalidStylables();
                var someStyleIsInvalid = (invalidStylables.length > 0);
                if (someStyleIsInvalid)
                {
                    // Scroll to the first one
                    var firstInvalidStylable = invalidStylables[0];
                    var editor = firstInvalidStylable.editor;
                    if (editor !== null)
                        editor.scrollIntoView();

                    // Display dialog to user
                    message = "The following CSS blocks are invalid and need to be corrected:<br><br>";
                    invalidStylables.forEach(function(declaration)
                    {
                        message += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;" + declaration.name + "&gt;<br>";
                    });
                    this.$.confirmationDialog.alert(message);
                    return;
                }

                this._applyAllStylables();
            },

            _onCopyCssButtonClicked: function(event, detail)
            {
                var clipboard = this.$.clipboard;
                clipboard.value = this.css;
                clipboard.copy();
            },

            _applyAllStylables: function()
            {
                // Create a parser
                var parser = new cssjs();

                // For each declaration
                var stylableCount = this.declarations.length;
                for (var stylableIndex = 0;
                     stylableIndex < stylableCount;
                     stylableIndex++)
                {
                    // Parse the declaration
                    var declaration = this.declarations[stylableIndex];
                    var css = declaration.value;
                    var expressions = parser.parseCSS(css);

                    // For each expression in the declaration
                    var expressionCount = expressions.length;
                    for (var expressionIndex = 0;
                         expressionIndex < expressionCount;
                         expressionIndex++)
                    {
                        var expression = expressions[expressionIndex];
                        var selector = expression.selector;
                        var rules = expression.rules;

                        var prefixedSelector = "--" + selector;

                        Polymer.updateStyles({prefixedSelector: '#ed0'});
                    }
                }
            },

            _collectInvalidStylables: function()
            {
                var invalidStylables = [];
                var count = this.declarations.length;
                for (var index = 0;
                     index < count;
                     index++)
                {
                    var declaration = this.declarations[index];
                    if (!declaration.isValid)
                        invalidStylables.push(declaration);
                }
                return invalidStylables;
            },

            // Declarations list changes

            _onDeclarationChanged: function(event)
            {
                this._onSettingChangedDebounced();
            },

            _onDeclarationsListChanged: function(changeRecord)
            {
                if (!changeRecord)
                    return;
                this._onSettingChangedDebounced();
            }

        });

    </script>
</dom-module>
